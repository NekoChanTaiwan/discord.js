"use strict";const Discord=require("discord.js"),NanaAPI=require("nana-api"),isImageURL=require("valid-image-url"),{token:token,prefix:prefix}=require("./config.json"),custom={randomActivity:{enable:!0,type:"COMPETING",array:["NekoChan 的 肉便器","NekoChan 的 性奴隸","NekoChan 的 小母狗","NekoChan 的 飛機杯"],switchTime:60},nHentai:{random:{command:"random",shortCommand:"r",Blacklist:{enable:!0,tags:["futanari","scat","pig man","ryona","coprohagia","spider girl","alien","pig girl","nipple fuck","males only","pig","yaoi","insect","guro","cannibalism","eggs","muscle"],artists:["sakamoto kafka"],languages:["english","japanese"]}}}},client=new Discord.Client,nanaAPI=new NanaAPI,commandPrefix=new RegExp(prefix),S=" [系統] ",E=" [事件] ";let commandStarting=!1;function getRandomInt(e){return Math.floor(Math.random()*Math.floor(e))}function getTime(){return(new Date).toLocaleString()}function nHentaiBlacklistFilter(e,t){if(!(e.length>0))return!1;for(let n=0;n<e.length;n++)if(t===e[n])return console.log(`[${getTime()}]${E}發現黑名單類型：${t}`),!0}console.log(`[${getTime()}]${S}腳本讀取中`),client.on("ready",()=>{console.log(`[${getTime()}]${E}已登入 ${client.user.tag}`);const e=()=>{client.user.setActivity(custom.randomActivity.array[getRandomInt(custom.randomActivity.array.length)],{type:custom.randomActivity.type}).then(e=>console.log(`[${getTime()}]${E}已設置狀態：${e.activities[0].name}`)).catch(e=>console.log(e)),setTimeout(()=>{e()},1e3*custom.randomActivity.switchTime)};custom.randomActivity.enable&&e()}),client.on("message",e=>{if(commandPrefix.test(e.content)&&!1===commandStarting)switch(e.content){case`${prefix}${custom.nHentai.random.command}`:case`${prefix}${custom.nHentai.random.shortCommand}`:commandStarting=!0;let t=null;e.channel.send(`\`\`\`[${getTime()}] 正在努力尋找本本...\`\`\``).then(e=>t=e);const n=()=>{let a=null,i="",o="",s="",l="",m="";nanaAPI.random().then(r=>{for(let e of r.tags)if("tag"===e.type){if(!0===custom.nHentai.random.Blacklist.enable&&!0===nHentaiBlacklistFilter(custom.nHentai.random.Blacklist.tags,e.name))return t.edit(`\`\`\`[${getTime()}] 發現黑名單類型：${e.name}，努力尋找其他本本中...\`\`\``),n();l+=`${e.name}, `}else switch(e.type){case"artist":if(!0===custom.nHentai.random.Blacklist.enable&&!0===nHentaiBlacklistFilter(custom.nHentai.random.Blacklist.artists,e.name))return t.edit(`\`\`\`[${getTime()}] 發現黑名單類型：${e.name}，努力尋找其他本本中...\`\`\``),n();o=e.name,s=`https://nhentai.net${e.url}`;break;case"language":if("english"===e.name||"japanese"===e.name||"chinese"===e.name){if(!0===custom.nHentai.random.Blacklist.enable&&!0===nHentaiBlacklistFilter(custom.nHentai.random.Blacklist.languages,e.name))return t.edit(`\`\`\`[${getTime()}] 發現黑名單類型：${e.name}，努力尋找其他本本中...\`\`\``),n();m=e.name}}o=""===o?"未分類":o,s=""===s?"https://nhentai.net/":s,l=""===l?"未分類":l,i=!0===custom.nHentai.random.Blacklist.enable?"過濾黑名單：已啟用":"過濾黑名單：已關閉",a=(new Discord.MessageEmbed).setColor("#ed2553").setTitle(r.title.pretty).setURL(`https://nhentai.net/g/${r.id}/`).setAuthor(`作者：${o}`,"",s).setThumbnail("https://i.imgur.com/r36VxQt.png").setDescription(i).addFields({name:"ＩＤ：",value:r.id,inline:!0},{name:"語言：",value:m,inline:!0},{name:"分類：",value:l}).setImage("").setFooter(`頁數：${r.num_pages}`),isImageURL(`https://t.nhentai.net/galleries/${r.media_id}/cover.jpg`).then(e=>{e?(a.setImage(`https://t.nhentai.net/galleries/${r.media_id}/cover.jpg`),c()):(a.setImage(`https://t.nhentai.net/galleries/${r.media_id}/cover.png`),c())});const c=()=>{e.channel.send(a).then(()=>{e.delete(),t.delete(),console.log(`[${getTime()}]${E}已發送本子：${r.id}`),commandStarting=!1}).catch(n=>{e.delete(),t.delete(),console.log(n),commandStarting=!1})}})};n()}}),console.log(`[${getTime()}]${S}腳本讀取完成`),client.login(token).catch(e=>console.log(e));